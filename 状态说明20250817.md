---
config:
  layout: dagre
---
flowchart TD
    Start(["用户输入"]) --> A["parse_input<br>解析用户输入"]
    A --> B["check_fields<br>检查缺失字段"]
    B --> C{"decide_next_phase<br>决定下一步"}
    C -- 有缺失字段 --> D["ask_question<br>生成追问"]
    C -- 达到最大轮次 --> End1(["结束<br>提示用户已达到最大对话轮次"])
    D --> End2(["等待用户输入<br>进入下一轮"])
    End2 -. 用户回答后 .-> A
    C -- 信息完整 --> F["preference_filter<br>偏好筛选"]
    F --> G["team_constraints<br>团队约束"]
    G --> H["weather_filter<br>天气过滤"]
    H --> I{"check_weather_result<br>检查天气约束结果"}
    I -- 需要重选日期或极端天气 --> End3(["结束<br>等待用户重新输入"])
    I -- 天气适宜 --> n1["scenic_spots_clustering<br>形成每日游玩候选列表"]
    n1 --> J["hotel_selection<br>酒店选择"]
    J --> L["transportation_planning<br>交通规划(生成多方案)"]
    L --> O["intensity_calculate<br>强度计算"]
    O --> n2["intensity_check<br>是否满足强度"]
    n2 -- 是 --> n3["restaurant_selection<br>餐厅选择"]
    n2 -- 否 --> n4["opt_intensity<br>强度优化可继续?(最多优化1次)"]
    n3 --> P["budget_calculate<br>预算检查"]
    P --> Q["budget_check1<br>是否满足预算"]
    Q -- 是 --> End4(["结束<br>生成最终行程"])
    B3["opt_hotel<br>优化酒店"] --> J2["hotel_selection_apply<br>应用新酒店"]
    J2 --> L2["transportation_planning<br>重规划交通"]
    L2 --> O2["intensity_calculate2<br>强度检查"]
    O2 --> n2b@{ label: "intensity_check2<br style=\"--tw-scale-x:\">是否满足强度" }
    n2b -- 是 --> P2@{ label: "budget_check4<br style=\"--tw-scale-x:\">预算是否合格" }
    B1["opt_transportation<br>优化交通方式"] --> n6@{ label: "budget_check3<br style=\"--tw-scale-x:\">预算是否给合格" }
    B2["opt_restaurant<br>优化餐厅"] --> S2@{ label: "budget_check2<br style=\"--tw-scale-x:\">预算是否合格" }
    S2 -- 否 --> BD_back3["返回动态决策(标记餐厅方向暂不可行)"]
    n6 -- 否 --> BD_back2["返回动态决策(标记交通方向暂不可行)"]
    n2b -- 否 --> BD_back1["返回动态决策(标记酒店方向暂不可行)"]
    P2 -- 是 --> End4
    n7["标记交通方向暂不可行&amp;标记餐厅方向暂不可行&amp;标记酒店方向暂不可行"] -- 否 --> BD["select_budget_adjustment_target<br>选择优化目标<br>"]
    BD --> B3 & B1 & B2
    Q -- 否 --> n7
    BD_back1 --> n7
    BD_back3 --> n7
    BD_back2 --> n7
    n7 -- 是 --> n8["结束<br>提醒用户提高预算"]
    n6 -- 是 --> End4
    S2 -- 是 --> End4
    n4 -- 是 --> J
    n4 --> n9@{ label: "结束<br style=\"--tw-scale-x:\">提醒用户尝试更换酒店位置或者景点" }
    n1@{ shape: rect}
    J@{ shape: rect}
    n2@{ shape: diam}
    n3@{ shape: rect}
    n4@{ shape: diam}
    P@{ shape: rect}
    Q@{ shape: diam}
    B3@{ shape: rect}
    n2b@{ shape: diam}
    P2@{ shape: diam}
    B1@{ shape: rect}
    n6@{ shape: diam}
    B2@{ shape: rect}
    S2@{ shape: diam}
    n7@{ shape: diam}
    BD@{ shape: rect}
    n8@{ shape: terminal}
    n9@{ shape: terminal}
